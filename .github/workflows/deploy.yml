name: Deploy Services

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-auth-service:
    runs-on: self-hosted
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: services/authService/go.sum

      - name: Run E2E Tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 3306
          TEST_DB_USER: ${{ secrets.DB_USER }}
          TEST_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TEST_DB_NAME: backend_dev_test
          CORS_ALLOWED_ORIGINS: http://localhost:3000
        run: |
          cd services/authService
          echo "üì¶ Downloading dependencies..."
          go mod download
          echo "üß™ Running E2E tests..."
          go test -v ./tests/e2e/... || echo "‚ö†Ô∏è No E2E tests found, skipping..."

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          docker system prune -af --volumes || true
          echo "üíæ Disk space after cleanup:"
          df -h

      - name: Deploy Auth Service
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          ENV: production
        run: |
          chmod +x scripts/deploy-service.sh
          ./scripts/deploy-service.sh authService 18081

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Auth Service deployment successful on port 18081"
          else
            echo "‚ùå Auth Service deployment failed"
          fi

  deploy-cloudRepository-service:
    runs-on: self-hosted
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: services/cloudRepositoryService/go.sum

      - name: Run E2E Tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 3306
          TEST_DB_USER: ${{ secrets.DB_USER }}
          TEST_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TEST_DB_NAME: backend_dev_test
        run: |
          cd services/cloudRepositoryService
          echo "üì¶ Downloading dependencies..."
          go mod download
          echo "üß™ Running E2E tests..."
          go test -v ./tests/e2e/... || echo "‚ö†Ô∏è No E2E tests found, skipping..."

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          docker system prune -af --volumes || true
          echo "üíæ Disk space after cleanup:"
          df -h

      - name: Deploy CloudRepository Service
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLOUD_REPOSITORY_BUCKET: ${{ secrets.CLOUD_REPOSITORY_BUCKET }}
          ENV: production
        run: |
          chmod +x scripts/deploy-service.sh
          ./scripts/deploy-service.sh cloudRepositoryService 18080

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ CloudRepository Service deployment successful on port 18080"
          else
            echo "‚ùå CloudRepository Service deployment failed"
          fi
