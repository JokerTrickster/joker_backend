name: Deploy Services

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/**'
      - 'shared/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (auth-service, game-service, payment-service, or all)'
        required: true
        default: 'all'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      game: ${{ steps.filter.outputs.game }}
      payment: ${{ steps.filter.outputs.payment }}
      deploy_all: ${{ steps.check.outputs.deploy_all }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check manual trigger
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.service }}" == "all" ]; then
              echo "deploy_all=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "deploy_all=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed services
        id: filter
        run: |
          # Check for changes in auth-service
          if git diff --name-only HEAD^ HEAD | grep -E '^(services/auth-service/|shared/)'; then
            echo "auth=true" >> $GITHUB_OUTPUT
          else
            echo "auth=false" >> $GITHUB_OUTPUT
          fi

          # Check for changes in game-service
          if git diff --name-only HEAD^ HEAD | grep -E '^(services/game-service/|shared/)'; then
            echo "game=true" >> $GITHUB_OUTPUT
          else
            echo "game=false" >> $GITHUB_OUTPUT
          fi

          # Check for changes in payment-service
          if git diff --name-only HEAD^ HEAD | grep -E '^(services/payment-service/|shared/)'; then
            echo "payment=true" >> $GITHUB_OUTPUT
          else
            echo "payment=false" >> $GITHUB_OUTPUT
          fi

          # Manual dispatch overrides
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SERVICE="${{ github.event.inputs.service }}"
            if [ "$SERVICE" == "auth-service" ] || [ "$SERVICE" == "all" ]; then
              echo "auth=true" >> $GITHUB_OUTPUT
            fi
            if [ "$SERVICE" == "game-service" ] || [ "$SERVICE" == "all" ]; then
              echo "game=true" >> $GITHUB_OUTPUT
            fi
            if [ "$SERVICE" == "payment-service" ] || [ "$SERVICE" == "all" ]; then
              echo "payment=true" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-auth-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: services/auth-service/go.sum

      - name: Run E2E Tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 3306
          TEST_DB_USER: ${{ secrets.DB_USER }}
          TEST_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TEST_DB_NAME: backend_dev_test
        run: |
          cd services/auth-service
          echo "üì¶ Downloading dependencies..."
          go mod download
          echo "üß™ Running E2E tests..."
          make test-e2e

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          docker system prune -af --volumes || true
          echo "üíæ Disk space after cleanup:"
          df -h

      - name: Deploy Auth Service
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          chmod +x scripts/deploy-service.sh
          ./scripts/deploy-service.sh auth-service 6000

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Auth Service deployment successful on port 6000"
          else
            echo "‚ùå Auth Service deployment failed"
          fi

  deploy-game-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.game == 'true'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: services/game-service/go.sum

      - name: Run E2E Tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 3306
          TEST_DB_USER: ${{ secrets.DB_USER }}
          TEST_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TEST_DB_NAME: backend_dev_test
        run: |
          cd services/game-service
          echo "üì¶ Downloading dependencies..."
          go mod download
          echo "üß™ Running E2E tests..."
          make test-e2e

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          docker system prune -af --volumes || true
          echo "üíæ Disk space after cleanup:"
          df -h

      - name: Deploy Game Service
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          chmod +x scripts/deploy-service.sh
          ./scripts/deploy-service.sh game-service 6001

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Game Service deployment successful on port 6001"
          else
            echo "‚ùå Game Service deployment failed"
          fi

  deploy-payment-service:
    needs: detect-changes
    if: needs.detect-changes.outputs.payment == 'true'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: services/payment-service/go.sum

      - name: Run E2E Tests
        env:
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 3306
          TEST_DB_USER: ${{ secrets.DB_USER }}
          TEST_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TEST_DB_NAME: backend_dev_test
        run: |
          cd services/payment-service
          echo "üì¶ Downloading dependencies..."
          go mod download
          echo "üß™ Running E2E tests..."
          make test-e2e

      - name: Clean up disk space
        run: |
          echo "üßπ Cleaning up disk space..."
          docker system prune -af --volumes || true
          echo "üíæ Disk space after cleanup:"
          df -h

      - name: Deploy Payment Service
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          chmod +x scripts/deploy-service.sh
          ./scripts/deploy-service.sh payment-service 6002

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Payment Service deployment successful on port 6002"
          else
            echo "‚ùå Payment Service deployment failed"
          fi
